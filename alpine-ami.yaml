variables:

  # NOTE:  Additional configuration is set via the `variables.json` file.
  # To use default values, simply `cp variables.json-default variables.json`.
  # See `variables.json-example` for full configuration variable descriptions.

  # NOTE:  Changing alpine_release requires modifying `make_ami.sh` -- don't
  # override this in `variables.json`!
  alpine_release: "3.8"


builders:
  - type: "amazon-ebssurrogate"

    ### Builder Instance Details

    vpc_id: "{{user `vpc`}}"
    subnet_id: "{{user `subnet`}}"
    security_group_id: "{{user `security_group`}}"
    instance_type: "{{user `build_instance_type`}}"
    associate_public_ip_address: "{{user `public_ip`}}"
    launch_block_device_mappings:
      - volume_type: "gp2"
        device_name: "{{user `volume_name`}}"
        delete_on_termination: "true"
        volume_size: "{{user `volume_size`}}"
    ssh_username: "ec2-user"
    source_ami_filter:
      # use the latest Amazon Linux AMI
      filters:
        virtualization-type: "hvm"
        root-device-type: "ebs"
        architecture: "x86_64"
        name: "amzn-ami-hvm-*-x86_64-gp2"
      owners:
        - "137112412989"
      most_recent: "true"

    ### Built AMI Details

    ami_name: "{{user `ami_name_prefix`}}{{user `alpine_release`}}-r{{user `ami_release`}}{{user `ami_name_suffix`}}"
    ami_description: "{{user `ami_desc_prefix`}}{{user `alpine_release`}}-r{{user `ami_release`}}{{user `ami_desc_suffix`}}"
    ami_virtualization_type: "hvm"
    ami_root_device:
      source_device_name: "{{user `volume_name`}}"
      device_name: "/dev/xvda"
      delete_on_termination: "true"
      volume_size: "{{user `volume_size`}}"
      volume_type: "gp2"
    ena_support: "{{user `ena_enable`}}"
    sriov_support: "{{user `sriov_enable`}}"
    ami_groups: "{{user `ami_access`}}"
    ami_regions: "{{user `deploy_regions`}}"


provisioners:
  - type: "shell"
    script: "make_ami.sh"
    execute_command: 'sudo sh -c "{{ .Vars }} {{ .Path }} {{user `volume_name`}} {{user `kernel_flavor`}} ''{{user `add_repos`}}'' ''{{user `add_pkgs`}}''"'
